<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أوقات الصلاة</title>

    <!-- axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Arabic Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: "Tajawal", sans-serif;
            background: #000;
            margin: 0;
            color: white;
            direction: rtl;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #card {
            height: 100vh;
            width: 100%;
            background: url("mosque-interior.jpg") center/cover no-repeat;
            backdrop-filter: blur(2px);
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            align-items: center;
        }

        #date {
            background: rgba(0, 0, 0, 0.6);
            width: 70%;
            padding: 15px 25px;
            border-radius: 20px;
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
        }

        .date-column {
            text-align: center;
        }

        #timings {
            display: flex;
            justify-content: space-evenly;
            flex-wrap: wrap;
            gap: 15px;
            padding-bottom: 20px;
        }

        .prayer,
        #countDown {
            width: 110px;
            padding: 12px;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.8);
            color: #000;
            text-align: center;
        }

        .prayer h2 {
            margin: 5px 0;
            font-size: 20px;
            font-weight: 700;
        }

        .prayer h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .small {
            font-size: 12px;
            color: #9fb0d9;
            margin-top: 6px;
        }

        #citySelect {
            padding: 6px 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <div id="card">
        <div id="date"></div>
        <select id="citySelect"></select>
        <div id="timings"></div>
        <div id="countDown">
            <h3 id="prayerName">—</h3>
            <h3 id="countdown">00:00:00</h3>
            <h4 class="small">الوقت المحلي: <span id="localTime">--:--:--</span></h4>
        </div>
    </div>

    <script>
        const moroccanCities = [
            { city: "Casablanca", lat: 33.5731, lon: -7.5898 },
            { city: "Rabat", lat: 34.0209, lon: -6.8416 },
            { city: "Fes", lat: 34.0331, lon: -5.0003 },
            { city: "Marrakesh", lat: 31.6295, lon: -7.9811 },
            { city: "Tangier", lat: 35.7595, lon: -5.8339 },
            { city: "Agadir", lat: 30.4278, lon: -9.5981 },
            { city: "Oujda", lat: 34.6814, lon: -1.9000 },
            { city: "Kenitra", lat: 34.2610, lon: -6.5802 },
            { city: "Tetouan", lat: 35.5785, lon: -5.3684 },
            { city: "Safi", lat: 32.3008, lon: -9.2349 },
            { city: "Meknes", lat: 33.8935, lon: -5.5473 },
            { city: "Laayoune", lat: 27.1253, lon: -13.1625 },
            { city: "Dakhla", lat: 23.6847, lon: -15.9570 },
            { city: "Errachidia", lat: 31.9314, lon: -4.4044 }
        ];

        const citySelect = document.getElementById("citySelect");
        moroccanCities.forEach(city => {
            const opt = document.createElement("option");
            opt.value = `${city.lat},${city.lon}`;
            opt.textContent = city.city;
            citySelect.appendChild(opt);
        });

        let currentLat = moroccanCities[0].lat;
        let currentLon = moroccanCities[0].lon;
        citySelect.value = `${currentLat},${currentLon}`;
        fetchPrayerTimes(currentLat, currentLon);

        let currentTarget;

        function pad(n) { return n < 10 ? "0" + n : n; }

        function parseTime(timeStr, dateObj) {
            const [h, m] = timeStr.split(":");
            const d = new Date(dateObj);
            d.setHours(h, m, 0, 0);
            return d;
        }

        function diffFromNow(futureDate) {
            let diff = Math.max(0, futureDate.getTime() - Date.now());
            const days = Math.floor(diff / (24 * 3600 * 1000));
            diff -= days * 24 * 3600 * 1000;
            const hours = Math.floor(diff / (3600 * 1000));
            diff -= hours * 3600 * 1000;
            const minutes = Math.floor(diff / (60 * 1000));
            diff -= minutes * 60 * 1000;
            const seconds = Math.floor(diff / 1000);
            return { days, hours, minutes, seconds, totalMs: futureDate - Date.now() };
        }

        function getNextPrayer(prayerTimes, prayerNamesArr) {
            const now = new Date();
            const list = prayerTimes.map((t, i) => ({
                index: i,
                name: prayerNamesArr[i],
                time: parseTime(t, now)
            }));
            for (const p of list) if (p.time.getTime() > now.getTime()) return p;
            // Tomorrow Fajr
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return { index: 0, name: prayerNamesArr[0], time: parseTime(prayerTimes[0], tomorrow) };
        }

        function updateCountdown() {
            const now = new Date();
            document.getElementById("localTime").textContent = pad(now.getHours()) + ":" + pad(now.getMinutes()) + ":" + pad(now.getSeconds());
            if (!currentTarget) return;
            if (Date.now() >= currentTarget.time.getTime()) {
                fetchPrayerTimes(currentLat, currentLon);
                return;
            }
            document.getElementById("prayerName").textContent = `الوقت المتبقي لصلاة ${currentTarget.name}`;
            const d = diffFromNow(currentTarget.time);
            const hoursTotal = d.days * 24 + d.hours;
            document.getElementById("countdown").textContent = pad(hoursTotal) + ":" + pad(d.minutes) + ":" + pad(d.seconds);
        }

        // let currentLat, currentLon;

        function fetchPrayerTimes(lat, lon) {
            const today = new Date();
            const y = today.getFullYear(), m = today.getMonth() + 1, d = today.getDate();
            axios.get(`https://api.aladhan.com/v1/timings/${d}-${m}-${y}?latitude=${lat}&longitude=${lon}&method=21`)
                .then(res => {
                    const data = res.data.data;
                    const pTimes = [data.timings.Fajr, data.timings.Dhuhr, data.timings.Asr, data.timings.Maghrib, data.timings.Isha];
                    const pNames = ["الفجر", "الظهر", "العصر", "المغرب", "العشاء"];

                    let months = {
                        1: "يناير",
                        2: "فبراير",
                        3: "مارس",
                        4: "أبريل",
                        5: "ماي",
                        6: "يونيو",
                        7: "يوليوز",
                        8: "غشت",
                        9: "شتنبر",
                        10: "أكتوبر",
                        11: "نونبر",
                        12: "دجنبر"
                    };

                    document.getElementById("date").innerHTML = `
                        <div class="date-column">${data.date.hijri.weekday.ar}</div>
                        <div class="date-column">${data.date.gregorian.day} ${months[data.date.gregorian.month.number]} ${data.date.gregorian.year}</div>
                        <div class="date-column">${data.date.hijri.day} ${data.date.hijri.month.ar} ${data.date.hijri.year}</div>
                    `;

                    const prayerNamesAll = { Fajr: "الفجر", Sunrise: "الشروق", Dhuhr: "الظهر", Asr: "العصر", Sunset: "الغروب", Maghrib: "المغرب", Isha: "العشاء" };
                    let timingsHTML = "";
                    for (let key in prayerNamesAll) timingsHTML += `<div class="prayer"><h2>${prayerNamesAll[key]}</h2><h3>${data.timings[key]}</h3></div>`;
                    document.getElementById("timings").innerHTML = timingsHTML;

                    currentTarget = getNextPrayer(pTimes, pNames);
                })
                .catch(err => console.error("API Error:", err));
        }

        citySelect.addEventListener("change", e => {
            const [lat, lon] = e.target.value.split(",");
            currentLat = lat;
            currentLon = lon;
            fetchPrayerTimes(lat, lon);
        });

        fetchPrayerTimes(currentLat, currentLon);
        setInterval(updateCountdown, 1000);
    </script>
</body>

</html>
